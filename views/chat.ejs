<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BULink</title>
    <link rel="stylesheet" type="text/css" href="/static/css/chat.css">
    <link rel="icon" sizes="any" href="static/Chat/Media/logo.png">
    <script src="/static/js/pop-up.js"></script>
</head>
<body>
<div>
    <div class="toolbar">
        <div class="logo-toolbar">
            <div class="square-logo"></div>
        </div>
        <div id="header1" class="header">
            <p align="center">
                <font color="#ffffff">Главная страница</font>
            </p>
        </div>
        <div id="about" class="round-button">
            <div class="round-logo">
                <img class="logo" alt="about" src="static/Chat/Media/about.png">
            </div>
        </div>
        <div id="settings" class="round-button">
            <div class="round-logo">
                <img class="logo" alt="setting" src="static/Chat/Media/settings.png">
            </div>
        </div>
        <div id="logout" class="round-button">
            <div class="round-logo">
                <img class="logo" alt="logout" src="static/Chat/Media/logout.png">
            </div>
        </div>

        <div id="pop-up" class="round-button" onclick="popUp()">
            <div class="round-logo">
                <img class="round-logo" alt="pop-up" src="static/Chat/Media//open-menu.png">
            </div>
        </div>
    </div>
</div>
<div class="main">
    <div class="left-part">
        <div class="left-top-part">
            <p align="center">
                <font color="#ffffff">Пользователи чата</font>
            </p>
        </div>
    </div>
    <div class="right-part">
        <div class="right-top-part">
            <p align="center" id="chat_name">
                <font color="#ffffff">Название чата</font>
            </p>
        </div>

        <ul id="messages"></ul>

        <form>
            <input type="text" id="m" class="messageText"/>
            <input type="submit" id="submitButton" value="Send" onclick="focusmessage()" class="SendMessage"/>
        </form>

    </div>
</div>
</body>
<script src="/socket.io/socket.io.js"></script>
<script>
    focusmessage = function getFocus() {
        document.getElementById("m").focus();
    }

</script>
<script>
    let userName = "<%= user.name %>";
    let room = "<%= roomname %>";
    let ID = "";
    var socket = io();

    document.getElementById("chat_name").textContent = room;

    socket.emit("join room", {username : userName, roomname : room});


    socket.on('send data',(data)=>{
        ID = data.id;
        console.log(" my ID:" + ID);
    })


    document
        .getElementsByTagName("form")[0]
        .addEventListener("submit", function (event) {
            event.preventDefault();
            socket.emit("chat message", {
                value: document.getElementById("m").value,
                user: userName,
                room: room,
                login: "<%= user.login %>"
            });

            document.getElementById("m").value = "";
        });
    socket.on("chat message", (data) => {
        console.log(data.data.user + ": " + data.id);
        displayMessage(data);
    });

    function displayMessage(data) {
        let authorClass = "";
        let divClass = "";

        if (data.id === ID) {
            console.log("This person has sent a message")
            authorClass = "me";
            divClass = "myDiv";
        } else {
            authorClass = "you";
            divClass = "yourDiv";
        }
        const div = document.createElement("div");
        div.className = divClass;
        const li = document.createElement("li");
        const p = document.createElement("p");
        p.className = "time";
        let now = new Date();
        let hours = now.getHours();
        let minutes = now.getMinutes();
        p.innerText = "" + hours + ":" + minutes;
        div.innerHTML =
            '<p class="' + authorClass + '">' + data.data.user +

            "</p>" + '<p class="message"> ' + data.data.value + "</p>" ;

        div.appendChild(p);
        li.appendChild(div);

        document.getElementById("messages").appendChild(li);

        li.scrollIntoView();
    }
</script>
</html>
